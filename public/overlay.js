(function(){function qs(name){return new URL(location.href).searchParams.get(name);}const profile=qs('profile')||'default';const token=qs('token')||'';const ws=new WebSocket((location.protocol==='https:'?'wss://':'ws://')+location.host);ws.addEventListener('open',()=>ws.send(JSON.stringify({type:'subscribe',profile,token})));let config={segments:[{label:'Empty',color:''}],soundEnabled:true,flashColor:'#ffff00',flashOpacity:0.6,flashDuration:600,showLegend:false};const canvas=document.getElementById('wheel');const ctx=canvas.getContext('2d');const W=canvas.width,H=canvas.height,CX=W/2,CY=H/2,R=Math.min(W,H)/2-20;let angle=0,isSpinning=false;function draw(a){ctx.clearRect(0,0,W,H);const segs=config.segments||[{label:'Empty',color:''}];const slice=(Math.PI*2)/segs.length;for(let i=0;i<segs.length;i++){const start=a+i*slice,end=start+slice;ctx.beginPath();ctx.moveTo(CX,CY);ctx.arc(CX,CY,R,start,end);ctx.closePath();const seg=segs[i]||{};const fill=(seg.color&&seg.color.trim()!=='')?seg.color:(i%2?'#222':'#111');ctx.fillStyle=fill;ctx.fill();ctx.strokeStyle='#333';ctx.lineWidth=3;ctx.stroke();ctx.save();ctx.translate(CX,CY);const mid=start+slice/2;ctx.rotate(mid+Math.PI/2);ctx.fillStyle='#fff';ctx.font='bold 18px sans-serif';ctx.textAlign='center';ctx.fillText(seg.label||'—',0,-R+48);ctx.restore();}ctx.beginPath();ctx.moveTo(CX,8);ctx.lineTo(CX-18,56);ctx.lineTo(CX+18,56);ctx.closePath();ctx.fillStyle='#ff3b81';ctx.fill();ctx.strokeStyle='#fff';ctx.stroke();}draw(angle);function animateSpin(target,duration=3000){if(isSpinning) return Promise.resolve();isSpinning=true;const start=performance.now();const from=angle;const delta=target-from;return new Promise(res=>{function f(now){const t=Math.min(1,(now-start)/duration);const eased=1-Math.pow(1-t,3);angle=from+delta*eased;draw(angle);if(t<1)requestAnimationFrame(f);else{isSpinning=false;res();}}requestAnimationFrame(f);});}function computeTargetForIndex(idx){const len=(config.segments||[]).length||1;const slice=(Math.PI*2)/len;const center=-(idx*slice+slice/2);const extra=(Math.floor(Math.random()*2)+4)*Math.PI*2;return center+extra;}const ding=document.getElementById('ding');function triggerFlash(){const el=document.getElementById('flash');el.style.background=config.flashColor||'rgba(255,255,0,0.3)';el.style.opacity=config.flashOpacity||0.6;el.style.transition=`opacity ${config.flashDuration||600}ms ease`;el.classList.remove('active');void el.offsetWidth;el.classList.add('active');setTimeout(()=>{el.style.opacity=0;},20);}ws.addEventListener('message',async(ev)=>{try{const msg=JSON.parse(ev.data);if(msg.type==='config'&&msg.profile===profile){config=msg.config;draw(angle);document.getElementById('legendBox').style.display=config.showLegend?'block':'none';}if(msg.type==='spin'&&msg.profile===profile){const idx=typeof msg.index==='number'?msg.index:Math.floor(Math.random()*(config.segments.length||1));await animateSpin(computeTargetForIndex(idx),msg.duration||3000);const last=document.getElementById('last');last.innerHTML='Last: '+(msg.label||(config.segments[idx]&&config.segments[idx].label)||'—')+(msg.test?' <span class="tag test">(test)</span>':'')+(msg.user?` (${msg.user})`:'');if(!msg.test&&config.soundEnabled){ding.currentTime=0;ding.play().catch(()=>{});triggerFlash();}}if(msg.type==='previewFlash'&&msg.profile===profile){if(config.soundEnabled){ding.currentTime=0;ding.play().catch(()=>{});}triggerFlash();const last=document.getElementById('last');last.innerHTML='Last: (preview) <span class="tag preview">(preview)</span>';}if(msg.type==='leaderboard'&&msg.profile===profile){} }catch(e){console.error(e);} });